<!DOCTYPE html>
<html>
<head>
	<title>Add Location</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="admin_add_location.css">
    <link rel="stylesheet" href="admin_add_location.css">
      
	<script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA",
		authDomain: "maps-ca38f.firebaseapp.com",
		databaseURL: "https://maps-ca38f.firebaseio.com",
		projectId: "maps-ca38f",
		storageBucket: "maps-ca38f.appspot.com",
		messagingSenderId: "6568625724"
	  };
	  firebase.initializeApp(config);
	</script>
</head>
<body>

	<div id="container_div">
		
		<div id="left_header_div"></div>
		<div id="header_content_div">
			<ul id="header_ul">
				<li class="header_li" ><a href="#" onclick="checkFeedback()">Check Feedback</a></li>
				<li class="header_li" id="selected_li"><a href="#">Add Location</a></li>
				<li class="header_li"><a href="#" onclick="editLocation()">Edit Locations</a></li>
			</ul>
		</div>
		<div id="right_header_div"></div>
		
		
		<div id="right_content_div"></div>
		
		<div id="container">
			<center><h2 class="tags" id="add_new_location_title">Add new Location</h2></center>
			<div id="add_location_container">
				<div id="add_location_1">
					<input type="text" id="first_name" class="input" placeholder="First Name"><br>
					<input type="text" id="last_name" class="input" placeholder="Last Name"><br>
					<input type="text" id="address" class="input" placeholder="Address"><br>
					<input type="text" id="city" class="input" placeholder="City"><br>
				</div>
				<div id="add_location_2">
					<h4 class="tags">Select State or Province</h4>
					<select id="state_select" class="select"></select>
					<h4 class="tags">Select Congregation</h4>
					<select id="cong_select" class="select"></select>
					<p>You must verify location before adding to database.</p>
					<center><input type="button" id="verify_location_btn" onclick="verify_location()" value="Verify Location"></center>
				</div>
			</div>
			<center><h3 id="name_already_saved">This persons location is already saved.</h3></center>
			<center><h3 id="location_saved_successfully">Location save successfully!</h3></center>
			<div id="maps_div">
				<div id="maps_container"></div>
				<center><input type="button" onclick="resetLocation()" value="Reset Pin" id="reset_location">
				<input type="button" id="save_location" class="save_button" value="Save Location"></center>
			</div>
			<div id="add_location_divider"></div>
			<div id="add_state_province_cong_container">
				<div id="add_s_p_c_1">
					<center><h2 class="tags">Add new State or Province</h2></center>
					<input type="text" id="state" class="input" placeholder="State or Province"><br>
					<center><input type="button" id="save_state" class="save_button" value="Save State or Province" onclick="saveState()"></center>
				</div>
				<div id="add_s_p_c_2">
					<center><h2 class="tags">Add new Congregation</h2></center>
					<input type="text" id="congregation" class="input" placeholder="Congregation"><br>
					<center><input type="button" id="save_congregation" class="save_button" value="Save Congregation" onclick="saveCongregation()"></center>
				</div>
			</div>
		</div>
	</div>	
	
	<div id="left_content_div"></div>

	<script>
		
		var mUser;
		var mMap;
		var mLatnLngFromAddress = {};
		var mNewLatnLngFromMap = {};
		var markersArray = [];
		
		document.getElementById("maps_div").style.display = "none";
		document.getElementById("location_saved_successfully").style.display = "none";
		document.getElementById("name_already_saved").style.display = "none";
    
		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				
			} else {
				location.href = "sign_in.html";
			}
		});
		
		var mCongregationMap = {};
		var mCongregationArray = [];
		
		var mStatesMap = {};
		var mStatesArray = [];
		
		var database = firebase.database();
		
		database.ref('congregations').on('value', function(snapshot){
			var congSelect = document.getElementById("cong_select");
			congSelect.innerHTML = "";
			parseCongSnapshot(snapshot);
		});
		
		database.ref('stateOrProvince').on('value', function(snapshot){
			var congSelect = document.getElementById("state_select");
			congSelect.innerHTML = "";
			parseStateSnapshot(snapshot);
		});
		
        document.getElementById("save_location").addEventListener("click", function(){
            
            var firstName = document.getElementById('first_name').value;
			var lastName = document.getElementById('last_name').value;
			var address = document.getElementById('address').value;
			var city = document.getElementById('city').value;
			var state = getSelectedText('state_select');
			var cong = getSelectedText('cong_select');
            
            if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
				console.log("Please fill the blanks");
                return;
            }
            
			var congId = mCongregationMap[cong];
			var stateId = mStatesMap[state];

			var userId = firebase.auth().currentUser.uid;
			
			var lat;
			var long;
			
			if(mNewLatnLngFromMap.lat == null || mNewLatnLngFromMap.lng == null){
				lat = mLatnLngFromAddress.lat;
				long = mLatnLngFromAddress.lng;
			}else{
				lat = mNewLatnLngFromMap.lat;
				long = mNewLatnLngFromMap.lng;
			}
			
			saveLocation(lat, long, firstName, lastName, city, stateId, address, congId, userId);
         
            document.getElementById('first_name').value = "";
			document.getElementById('last_name').value = "";
			document.getElementById('address').value = "";
			document.getElementById('city').value = ""
			
			document.getElementById("maps_div").style.display = "none";
			document.getElementById("location_saved_successfully").style.display = "block";
			document.getElementById("name_already_saved").style.display = "none";
			
			var location_saved = document.getElementById("location_saved_successfully");
			location_saved.style.opacity = 1;
			location_saved.style.filter = 'alpha(opacity=' + 1 * 100 + ")";
			
			setTimeout(function(){ 
				fade(location_saved); 
			}, 1000);
			
			deleteMarkers();
			
			mLatnLngFromAddress = {};
			mNewLatnLngFromMap = {};
            
        });
		
	    function saveLocation(varLatitude, varLongitude, varFirstName, varLastName, varCity, varState, varAddress, varCong, varUserId){
			var firstName = capitalizeFirstLetter(varFirstName);
			var lastName = capitalizeFirstLetter(varLastName);
            var ref = firebase.database().ref('locations').push();
            var key = ref.getKey();
            ref.set({
                latitude: varLatitude,
                longitude: varLongitude,
				firstName: firstName,
				lastName: lastName,
				address: varAddress,
				city: varCity,
				congregation: varCong,
				state: varState,
                locationId: key,
				userId: varUserId
            });
        }
        
		function saveState(){
			var state = document.getElementById("state").value;
			if(state.length == 0){
				return;
			}
			var ref = firebase.database().ref('stateOrProvince').push();
			var key = ref.getKey();
			ref.set({
				stateId: key,
				state: state
			});
			document.getElementById("state").value = "";
		}
		
		function saveCongregation(){
			var cong = document.getElementById("congregation").value;
			if(cong.length == 0){
				return;
			}
			var ref = firebase.database().ref('congregations').push();
			var key = ref.getKey();
			ref.set({
				congregationId: key,
				congregation: cong
			});
			document.getElementById("congregation").value = "";
		}
		
		function parseCongSnapshot(snapshot) {
			var congSelect = document.getElementById("cong_select");
	   		snapshot.forEach(function(childSnapshot) {
		   		var name = childSnapshot.val().congregation;
		   		var nameId = childSnapshot.val().congregationId;

		   		var node = document.createElement('option');
				node.value = name;
				node.innerHTML = name;
				congSelect.appendChild(node);

		   		mCongregationArray.push(name);
		   		mCongregationMap[name] = nameId;
    	   	});

	     };
		
		function parseStateSnapshot(snapshot){
			var stateSelect = document.getElementById("state_select");
			snapshot.forEach(function(childSnapshot){
				var name = childSnapshot.val().state;
				var nameId = childSnapshot.val().stateId;
				
				var node = document.createElement('option');
				node.value = name;
				node.innerHTML = name;
				stateSelect.appendChild(node);
				
				mStatesArray.push(name);
				mStatesMap[name] = nameId;
				
			})
		};
		
		function getSelectedText(elementId) {
			var elt = document.getElementById(elementId);

			if (elt.selectedIndex == -1)
				return null;

			return elt.options[elt.selectedIndex].text;
		}
		
		function verify_location(){

			var firstName = document.getElementById('first_name').value;
			var lastName = document.getElementById('last_name').value;
			var address = document.getElementById('address').value;
			var city = document.getElementById('city').value;
			var state = getSelectedText('state_select');
			var cong = getSelectedText('cong_select');

			if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
return;
}

			var databaseRef = firebase.database().ref('locations').orderByChild("firstName").equalTo(firstName);
			databaseRef.on('value', function(snapshot){
				var array = snapshotToArray(snapshot);
				if(areNamesInArray(array, firstName, lastName)){
					document.getElementById("name_already_saved").style.display = "block";
					document.getElementById("maps_div").style.display = "none";
				}else{
					document.getElementById("name_already_saved").style.display = "none";
					document.getElementById("maps_div").style.display = "block";

					var addressString = address.split(" ");
					var finishedAddresString = "";
					var cityAndStateString = "";
					for(var i=0; addressString.length > i; i++){
						var item = addressString[i];
						finishedAddresString = finishedAddresString + item + "+";	
					}

					cityAndStateString = city + "+" + state;

					var apiKey = "&key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA";
					var baseUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=";
					var url = baseUrl + finishedAddresString + cityAndStateString + apiKey;
					var request = new XMLHttpRequest();
					request.onreadystatechange = function(){
						if(this.readyState == 4 && this.status == 200){
							var json = JSON.parse(this.responseText);
							var lat_n_long = json.results[0].geometry.location;

							var lat = lat_n_long.lat;
							var long = lat_n_long.lng;

							var congId = mCongregationMap[cong];
							var stateId = mStatesMap[state];

							var userId = firebase.auth().currentUser.uid;

							mLatnLngFromAddress = {lat: lat, lng: long};

							mMap= new google.maps.Map(document.getElementById('maps_container'), {
								zoom: 18,
								center: mLatnLngFromAddress,
								mapTypeId: 'satellite'
							});

							var marker = new google.maps.Marker({
								position: mLatnLngFromAddress,
								map: mMap
							});
							markersArray.push(marker);
							setMapOnAll(mMap);

							google.maps.event.addListener(mMap, "click", function (e) {

								deleteMarkers();

								//lat and lng is available in e object
								var latLng = e.latLng;
								mNewLatnLngFromMap = {lat: latLng.lat(), lng: latLng.lng()}

								var marker = new google.maps.Marker({
									position: mNewLatnLngFromMap,
									map: mMap
								});
								markersArray.push(marker);
								setMapOnAll(mMap);

							});

						}else{

						}
					}
					request.open('GET', url);
					request.send();
				}
			})
		}
		
		function resetLocation(){
			deleteMarkers();
			var marker = new google.maps.Marker({
			  position: mLatnLngFromAddress,
			  map: mMap
			});
			markersArray.push(marker);
			setMapOnAll(mMap);
			mMap.panTo(mLatnLngFromAddress);
		}
       
		function setMapOnAll(map) {
			for (var i = 0; i < markersArray.length; i++) {
			  markersArray[i].setMap(map);
			}
		  }
		
		function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}

		function deleteMarkers() {
			setMapOnAll(null);
			markersArray = [];
		  }
		
		function fade(element) {
			var op = 1;  // initial opacity
			var timer = setInterval(function () {
				if (op <= 0.1){
					clearInterval(timer);
					element.style.display = 'none';
				}
				element.style.opacity = op;
				element.style.filter = 'alpha(opacity=' + op * 100 + ")";
				op -= op * 0.1;
			}, 30);
		}
		
		function checkFeedback(){
			location.href = "admin_check_feedback.html"
		}
		
		function snapshotToArray(snapshot) {
			var returnArr = [];

			snapshot.forEach(function(childSnapshot) {
				var item = childSnapshot.val();
				item.key = childSnapshot.key;

				returnArr.push(item);
			});

			return returnArr;
		};

		function areNamesInArray(array, firstNameToTest, lastNameToTest){
			for(var i=0; i < array.length; i++){
				var firstName = array[i].firstName;
				var lastName = array[i].lastName;
				
				if(firstName == firstNameToTest && lastName == lastNameToTest){
					return true;
				}
			}
			return false;
		}
		
		function editLocation(){
			location.href = "admin_edit_location.html"
		}
	</script>
	
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA">
	</script>

</body>
</html> 