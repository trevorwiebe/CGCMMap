<!DOCTYPE html>
<html>
<head>
	<title>Add Location</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="admin.css">
    <link rel="stylesheet" href="admin.css">
      
	<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA",
		authDomain: "maps-ca38f.firebaseapp.com",
		databaseURL: "https://maps-ca38f.firebaseio.com",
		projectId: "maps-ca38f",
		storageBucket: "maps-ca38f.appspot.com",
		messagingSenderId: "6568625724"
	  };
	  firebase.initializeApp(config);
	</script>
</head>
<body>

	<div id="loading_div">
		<div id="loader"></div>
	</div>
	
	<div id="nav_div">
		<div id="left_header_div"></div>
			<div id="header_content_div">
				<div id="menu_container" onclick="openNav()">
					<div class="menu_style"></div>
					<div class="menu_style"></div>
					<div class="menu_style"></div>
				</div>
				<ul id="header_ul">
					<li class="header_li"><a onclick="navAddLocation()">Add Location</a></li>
					<li class="header_li"><a onclick="navEditLocation()">Edit Locations</a></li>
					<li class="header_li"><a onclick="navCheckFeedback()">Check Feedback</a></li>
				</ul>
			</div>
		<div id="right_header_div"></div>
	</div>
	
	<div id="side_nav" class="sidenav">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
		<a href="#" onclick="navAddLocation()">Add Location</a>
		<div class="nav_divider_div"></div>
		<a href="#" onclick="navEditLocation()">Edit Locations</a>
		<div class="nav_divider_div"></div>
		<a href="#" onclick="navCheckFeedback()">Check Feedback</a>
	</div>
	
	<div id="shadow_div"></div>
	
	<div id="content_div">
	
		<div id="right_content_div"></div>
		
		<div id="add_location_div_container">
			<center><h2 class="tags" id="add_new_location_title">Add new Location</h2></center>
			<div id="add_location_container">
				<div id="add_location_1">
					<input type="text" id="first_name" class="input" placeholder="First Name"><br>
					<input type="text" id="last_name" class="input" placeholder="Last Name"><br>
					<input type="text" id="address" class="input" placeholder="Address"><br>
					<input type="text" id="city" class="input" placeholder="City"><br>
				</div>
				<div id="add_location_2">
					<h4 class="tags">Select State or Province</h4>
					<select id="state_select" class="select"></select>
					<h4 class="tags">Select Congregation</h4>
					<select id="cong_select" class="select"></select>
					<p>You must verify location before adding to database.</p>
					<center><input type="button" id="verify_location_btn" onclick="verify_location()" value="Verify Location"></center>
				</div>
			</div>
			<center><h3 id="message_center_add_location"></h3></center>
			<div id="maps_div">
				<div id="maps_container"></div>
				<center><input type="button" onclick="resetPins()" value="Reset Pin" id="reset_location">
				<input type="button" id="save_location" onclick="saveLocationBtn()" class="save_button" value="Save Location"></center>
			</div>
			<div id="add_location_divider"></div>
			<div id="add_state_province_cong_container">
				<div id="add_s_p_c_1">
					<center><h2 class="tags">Add new State or Province</h2></center>
					<center><input type="text" id="state" class="input" placeholder="State or Province"><br></center>
					<center><p id="state_or_province_message"></p></center>
					<center><input type="button" id="save_state" class="save_button" value="Save State or Province" onclick="saveState()"></center>
				</div>
				<div id="add_s_p_c_2">
					<center><h2 class="tags">Add new Congregation</h2></center>
					<input type="text" id="congregation" class="input" placeholder="Congregation"><br>
					<center><p id="cong_message"></p></center>
					<center><input type="button" id="save_congregation" class="save_button" value="Save Congregation" onclick="saveCongregation()"></center>
				</div>
			</div>
		</div>
		
		<div id="edit_location_div">
			<center><h2>Edit or Delete locations</h2></center>
			
			<center><input type="text" class="input" placeholder="Search for location", id="edit_search_location" onkeyup="searchForPlacesToEdit()"></center>
			<center><div id="divider_div"></div></center>
			<center><ul id="locations_to_edit_ul"></ul></center>
			
			<div id="verify_edit_location_div">
				
				<div id="edit_location_1">
					<input type="text" placeholder="First Name" id="edit_first_name" class="input"><br>
					<input type="text" placeholder="Last Name" id="edit_last_name" class="input"><br>
					<input type="text" placeholder="Address" id="edit_address" class="input"><br>
					<input type="text" placeholder="City" id="edit_city" class="input"><br>
				</div>
				
				<div id="edit_location_2">
					<h4 class="tags">Select State or Province</h4>
					<select id="edit_state_select" class="select"></select>
					<h4 class="tags">Select Congregation</h4>
					<select id="edit_cong_select" class="select"></select><br>
					<input type="button" onclick="deleteThisLocation()" id="delete_this_location_btn" value="Delete this location">
				</div>
				
			</div>
			
			<center><h3 id="edit_location_message"></h3></center>
			
			<center><div id="edit_map_location"></div></center>
			
			<center><input value="Update Location" class="save_button" id="update_location_btn" type="button" onclick="updateLocation()"></center>
			
		</div>
	
		<div id="check_feedback_div">
			<center><h3 id="unresolved_feedback_h">Unresolved Feedback</h3></center>
			<ul id="unresolved_feedback_ul"></ul>
			
			<center><h3 id="resolved_feedback_h">Resolved Feedback</h3></center>
			<ul id="resolved_feedback_ul"></ul>
			
			<div id="view_feedback">
				<div id="feedback_content">
					<center><h3>Feedback</h3></center>
					<p id="feedback_whats_wrong" class="show_feedback_p"></p>
					<p id="feedback_notes" class="show_feedback_p"></p>
					<p id="feedback_date" class="show_feedback_p"></p>
					<center><h3>Location in question</h3></center>
					<p id="first_and_last_name" class="show_feedback_p">test</p>
					<p id="feedback_congregation" class="show_feedback_p">test</p>
					<p id="feedback_address" class="show_feedback_p">test</p>
					<p id="feedback_city_and_state" class="show_feedback_p">test</p>
				</div>
					<div id="feedback_button_bar">
						<button id="feedback_cancel" onclick="feedback_cancel()">Cancel</button>
						<button id="feedback_mark_resolved" onclick="markResolved()">Mark as resolved</button>
						<button id="feedback_edit_location" onclick="feedbackEditLocation()">Edit Location</button>
					</div>
			</div>
			<div id="loading_feedback">
				<div id="feedback_loader"></div>
			</div>
		</div>
		
		<div id="left_content_div"></div>
	</div>

	<script>
		
		// Member variables
		var mMap;
		var mLatnLngFromAddress = {};
		var mNewLatnLngFromMap = {};
		var mEditLatnLngFromAddress = {};
		var mEditNewLatnLngFromMap = {};
		var markersArray = [];
		var mCongregationMap = {};
		var mCongregationMapIds = {};
		var mCongregationArray = [];
		var mStatesMap = {};
		var mStateMapIds = {};
		var mStatesArray = [];
		var mLocationId;
		var mSelectedDate;
		var mUserId;
		var mCurrentUserId;
		var mLocationThatCurrentUserPutIn = {};
		var mLocationFeedbackArray = {};
		var mIsEditingFromCheckFeedback = false;
		
		// hide elements that are not needed
		document.getElementById("maps_div").style.display = "none";
		document.getElementById("edit_location_div").style.display = "none";
		document.getElementById("check_feedback_div").style.display = "none";
		document.getElementById("add_location_div_container").style.display = "none";
		document.getElementById("shadow_div").style.visibility = "hidden";
		document.getElementById("cong_message").style.display = "none";
		document.getElementById("state_or_province_message").style.display = "none";
		
		document.onclick = closeMenus;
	
		/*
			*****  CODE USED FOR MORE THAN ONE ADMIN ACTIVITY  *****
		*/
		var database = firebase.database();
		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				mCurrentUserId = user.uid;
				database.ref('locationFeedback').child(mCurrentUserId).orderByChild("date").on('value', function(snapshot){
					mLocationFeedbackArray = snapshotToArray(snapshot);
					document.getElementById("add_location_div_container").style.display = "block";
					document.getElementById("loading_div").style.display = "none";
				})
				
				database.ref('locations').orderByChild("userId").equalTo(mCurrentUserId).on('value', function(snapshot){
					mLocationThatCurrentUserPutIn = snapshotToArray(snapshot);
				});
			} else {
				mCurrentUserId = null;
			}
		});
		
		function openNav() {
			document.getElementById("shadow_div").style.visibility = "visible";
			document.getElementById("side_nav").style.visibility = "visible";
			document.getElementById("side_nav").style.width = "300px";
		}

		function closeNav() {
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("side_nav").style.width = "0";
		}
		
		function setMessage(id, message, type){
			var messageCenter = document.getElementById(id);
			messageCenter.style.display = "block";
			messageCenter.style.opacity = 1;
			messageCenter.style.filter = 'alpha(opacity=' + 1 * 100 + ")";
			messageCenter.innerHTML = message;
			switch(type){
				case 0:
					// Error
					messageCenter.style.color = "#B71C1C";
					messageCenter.style.backgroundColor = "#E57373";
					break;
				case 1:
					// Not an Error
					messageCenter.style.color = "#1B5E20";
					messageCenter.style.backgroundColor = "#66BB6A";
					break;
				default:
					messageCenter.style.color = "white";
					messageCenter.style.backgroundColor = "white";
			}
			setTimeout(function(){ 
				fade(messageCenter); 
			}, 2000);
		}
		
		function isNotCapital(word){
		  return word[0] !== word[0].toUpperCase();
		}
		
		function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}
		
		function closeMenus(e){
			if(e.target.id === "shadow_div"){
			
				var check_feedback = document.getElementById("view_feedback");
				var style = window.getComputedStyle(check_feedback);
				if(style.visibility === 'visible'){
					document.getElementById("shadow_div").style.visibility = "hidden";
					check_feedback.style.visibility = "hidden";
					
					document.getElementById("loading_feedback").style.visibility = "hidden";
				}
				
				// close nav drawer
				var nav_drawer = document.getElementById("side_nav");
				var nav_style = window.getComputedStyle(nav_drawer);
				if(nav_style.width !== '0px'){
					closeNav();
				}
				
			}	
		}
		
		database.ref('congregations').on('value', function(snapshot){
			var congSelect = document.getElementById("cong_select");
			congSelect.innerHTML = "";
			parseCongSnapshot(snapshot);
		});
		
		database.ref('stateOrProvince').on('value', function(snapshot){
			var congSelect = document.getElementById("state_select");
			congSelect.innerHTML = "";
			parseStateSnapshot(snapshot);
		});
		
		
		/*
			*****  ADD LOCATIONS CODE   *****
		*/
		
		function saveLocationBtn(){
			 var firstName = document.getElementById('first_name').value;
			var lastName = document.getElementById('last_name').value;
			var address = document.getElementById('address').value;
			var city = document.getElementById('city').value;
			var state = getSelectedText('state_select');
			var cong = getSelectedText('cong_select');
            
            if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
                setMessage("message_center_add_location", "Please fill all the blanks", 0);
				return;
            }
            
			var congId = mCongregationMap[cong];
			var stateId = mStatesMap[state];

			var userId = firebase.auth().currentUser.uid;
			
			var lat;
			var long;
			
			if(mNewLatnLngFromMap.lat == null || mNewLatnLngFromMap.lng == null){
				lat = mLatnLngFromAddress.lat;
				long = mLatnLngFromAddress.lng;
			}else{
				lat = mNewLatnLngFromMap.lat;
				long = mNewLatnLngFromMap.lng;
			}
			
			saveLocation(lat, long, firstName, lastName, city, stateId, address, congId, userId, Date.now());
         
            document.getElementById('first_name').value = "";
			document.getElementById('last_name').value = "";
			document.getElementById('address').value = "";
			document.getElementById('city').value = ""
			
			document.getElementById("maps_div").style.display = "none";
			setMessage("message_center_add_location", "Location saved successfully", 1);
			
			deleteMarkers();
			
			mLatnLngFromAddress = {};
			mNewLatnLngFromMap = {};
		}
		
	    function saveLocation(varLatitude, varLongitude, varFirstName, varLastName, varCity, varState, varAddress, varCong, varUserId, varDate){
			var firstName = capitalizeFirstLetter(varFirstName);
			var lastName = capitalizeFirstLetter(varLastName);
			var firstAndLastName = firstName + " " + lastName;
            var ref = firebase.database().ref('locations').push();
            var key = ref.getKey();
            ref.set({
				firstAndLastName: firstAndLastName,
				date: varDate,
                latitude: varLatitude,
                longitude: varLongitude,
				firstName: firstName,
				lastName: lastName,
				address: varAddress,
				city: varCity,
				congregation: varCong,
				state: varState,
                locationId: key,
				userId: varUserId
            });
        }
        
		function saveState(){
			var state = document.getElementById("state").value;
			if(state.length == 0){
				setMessage("state_or_province_message", "Please fill the blank", 0);
				return;
			}
			if(mStatesArray.indexOf(state) > -1){
				setMessage("state_or_province_message", state + " was already added", 0);
				return;
			}
			if(isNotCapital(state)){
				setMessage("state_or_province_message", "State or province must be capitalized", 0);
				return;
			}
			var ref = firebase.database().ref('stateOrProvince').push();
			var key = ref.getKey();
			ref.set({
				stateId: key,
				state: state
			});
			setMessage("state_or_province_message", state + " was added successfully", 1);
			document.getElementById("state").value = "";
		}
		
		function saveCongregation(){
			var cong = document.getElementById("congregation").value;
			if(cong.length == 0){
				setMessage("cong_message", "Please fill the blank", 0);
				return;
			}
			if(mCongregationArray.indexOf(cong) > -1){
				setMessage("cong_message", "Congregation already added", 0);
				return;
			}
			if(isNotCapital(cong)){
				setMessage("cong_message", "Congregation must be capitalized", 0);
				return;
			}
			var ref = firebase.database().ref('congregations').push();
			var key = ref.getKey();
			ref.set({
				congregationId: key,
				congregation: cong
			});
			setMessage("cong_message", cong + " was added successfully", 1);
			document.getElementById("congregation").value = "";
		}
		
		function getSelectedText(elementId) {
			var elt = document.getElementById(elementId);

			if (elt.selectedIndex == -1)return null;

			return elt.options[elt.selectedIndex].text;
		}
		
		function verify_location(){

			var firstName = document.getElementById('first_name').value;
			var lastName = document.getElementById('last_name').value;
			var address = document.getElementById('address').value;
			var city = document.getElementById('city').value;
			var state = getSelectedText('state_select');
			var cong = getSelectedText('cong_select');

			if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
				setMessage("message_center_add_location", "Please fill all the blanks",0);
				return;
			}

			if(isNotCapital(firstName) || isNotCapital(lastName) || isNotCapital(city)){
				setMessage("message_center_add_location", "First name, last name and city must be capitalized",0);
				return;
			}
			var databaseRef = firebase.database().ref('locations').orderByChild("firstName").equalTo(firstName);
			databaseRef.on('value', function(snapshot){
				var array = snapshotToArray(snapshot);
				if(areNamesInArray(array, firstName, lastName)){
					setMessage("message_center_add_location", "This person's location is already saved", 0);
					document.getElementById("maps_div").style.display = "none";
				}else{
					var addressString = address.split(" ");
					var finishedAddresString = "";
					var cityAndStateString = "";
					for(var i=0; addressString.length > i; i++){
						var item = addressString[i];
						finishedAddresString = finishedAddresString + item + "+";	
					}

					cityAndStateString = city + "+" + state;

					var apiKey = "&key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA";
					var baseUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=";
					var url = baseUrl + finishedAddresString + cityAndStateString + apiKey;
					var request = new XMLHttpRequest();
					request.onreadystatechange = function(){
						if(this.readyState == 4 && this.status == 200){
							var json = JSON.parse(this.responseText);
							var successCode = json.status;
							if(successCode === "ZERO_RESULTS"){
								setMessage("message_center_add_location", "Address is unknown, please try a different one", 0);
							}else{
								document.getElementById("maps_div").style.display = "block";
								var lat_n_long = json.results[0].geometry.location;

								var lat = lat_n_long.lat;
								var long = lat_n_long.lng;

								var congId = mCongregationMap[cong];
								var stateId = mStatesMap[state];

								var userId = firebase.auth().currentUser.uid;

								mLatnLngFromAddress = {lat: lat, lng: long};

								mMap= new google.maps.Map(document.getElementById('maps_container'), {
									zoom: 18,
									center: mLatnLngFromAddress,
									mapTypeId: 'satellite'
								});

								var marker = new google.maps.Marker({
									position: mLatnLngFromAddress,
									map: mMap
								});
								markersArray.push(marker);
								setMapOnAll(mMap);

								google.maps.event.addListener(mMap, "click", function (e) {

									deleteMarkers();

									//lat and lng is available in e object
									var latLng = e.latLng;
									mNewLatnLngFromMap = {lat: latLng.lat(), lng: latLng.lng()}

									var marker = new google.maps.Marker({
										position: mNewLatnLngFromMap,
										map: mMap
									});
									markersArray.push(marker);
									setMapOnAll(mMap);

								});	
							}

						}else{

						}
					}
					request.open('GET', url);
					request.send();
				}
			})
		}
		
		function resetPins(){
			deleteMarkers();
			var marker = new google.maps.Marker({
			  position: mLatnLngFromAddress,
			  map: mMap
			});
			markersArray.push(marker);
			setMapOnAll(mMap);
			mMap.panTo(mLatnLngFromAddress);
		}
		
		function parseCongSnapshot(snapshot) {
			var congSelect = document.getElementById("cong_select");
	   		snapshot.forEach(function(childSnapshot) {
		   		var name = childSnapshot.val().congregation;
		   		var nameId = childSnapshot.val().congregationId;

		   		var node = document.createElement('option');
				node.value = name;
				node.innerHTML = name;
				congSelect.appendChild(node);

		   		mCongregationArray.push(name);
		   		mCongregationMap[name] = nameId;
				mCongregationMapIds[nameId] = name;
    	   	});

	     };
		
		function parseStateSnapshot(snapshot){
			var stateSelect = document.getElementById("state_select");
			var editStateSelect = document.getElementById("edit_state_select");
			snapshot.forEach(function(childSnapshot){
				var name = childSnapshot.val().state;
				var nameId = childSnapshot.val().stateId;
				
				var node = document.createElement('option');
				node.value = name;
				node.innerHTML = name;
				
				stateSelect.appendChild(node);
				
				mStatesArray.push(name);
				mStatesMap[name] = nameId;
				mStateMapIds[nameId] = name;
				
			})
		};
       
		function setMapOnAll(map) {
			for (var i = 0; i < markersArray.length; i++) {
			  markersArray[i].setMap(map);
			}
		  }
		
		function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}

		function deleteMarkers() {
			setMapOnAll(null);
			markersArray = [];
		  }
		
		function fade(element) {
			var op = 1;  // initial opacity
			var timer = setInterval(function () {
				if (op <= 0.1){
					clearInterval(timer);
					element.style.display = 'none';
				}
				element.style.opacity = op;
				element.style.filter = 'alpha(opacity=' + op * 100 + ")";
				op -= op * 0.1;
			}, 30);
		}
		
		function snapshotToArray(snapshot) {
			var returnArr = [];

			snapshot.forEach(function(childSnapshot) {
				var item = childSnapshot.val();
				item.key = childSnapshot.key;

				returnArr.push(item);
			});

			return returnArr;
		};

		function areNamesInArray(array, firstNameToTest, lastNameToTest){
			for(var i=0; i < array.length; i++){
				var firstName = array[i].firstName;
				var lastName = array[i].lastName;
				
				if(firstName == firstNameToTest && lastName == lastNameToTest){
					return true;
				}
			}
			return false;
		}
		
		function navAddLocation(){
			markersArray = [];
			closeNav();
			document.getElementById("add_location_div_container").style.display = "block";
			document.getElementById("edit_location_div").style.display = "none";
			document.getElementById("check_feedback_div").style.display = "none";
		}
		
		
		/*
			*****  EDIT ITEMS CODE   *****
		*/
		function navEditLocation(){
			markersArray = [];
			closeNav();
			document.getElementById("edit_location_div").style.display = "block";
			document.getElementById("add_location_div_container").style.display = "none";
			document.getElementById("check_feedback_div").style.display = "none";
			document.getElementById("verify_edit_location_div").style.display = "none";
			document.getElementById("edit_map_location").style.display = "none";
			document.getElementById("update_location_btn").style.display = "none";
			
			var editSelectState = document.getElementById("edit_state_select");
			var editSelectCong = document.getElementById("edit_cong_select");
			
			for(var i=0; mStatesArray.length > i; i++){
				var name = mStatesArray[i];
				var node = document.createElement('option');
				node.value = name;
				node.innerHTML = name;
				
				editSelectState.appendChild(node);
			}
			
			for(var i=0; mCongregationArray.length >i; i++){
				var cong = mCongregationArray[i];
				var node = document.createElement('option');
				node.value = cong;
				node.innerHTML = cong;
				
				editSelectCong.appendChild(node);
			}
		}
		
		function searchForPlacesToEdit(){
			
			var searchToEditItem = capitalizeFirstLetter(document.getElementById("edit_search_location").value);
			
			var locationsToEdit = document.getElementById("locations_to_edit_ul");

			document.getElementById("verify_edit_location_div").style.display = "none";
			document.getElementById("edit_map_location").style.display = "none";
			document.getElementById("update_location_btn").style.display = "none";
			
			
			if(searchToEditItem.length == 0 || searchToEditItem == null){
				locationsToEdit.style.display = "none";
				return;
			}
			
				locationsToEdit.innerHTML = "";
				locationsToEdit.style.display = "block";
				
				var searchAndFoundItems = [];
			
			
				for(var t=0; mLocationThatCurrentUserPutIn.length >t; t++){
					var array = mLocationThatCurrentUserPutIn[t];
					var firstName = array.firstName;
					if(checkIfNameStartsWithString(searchToEditItem, firstName)){
						searchAndFoundItems.push(array);  
					}
				};
			
				for(var j=0; searchAndFoundItems.length > j; j++){
					var itemArray = searchAndFoundItems[j];
					var firstName = itemArray.firstName;
					var lastName = itemArray.lastName;
					var locationId = itemArray.locationId;
					
					var name = firstName + " " + lastName;

					var ul = document.getElementById('locations_to_edit_ul');
					var li = document.createElement("li");
					li.appendChild(document.createTextNode(name));
					li.setAttribute("id", "edit_li_items");
					li.setAttribute("myLocationId", locationId);
					ul.appendChild(li);
				}

				var list = document.getElementById("locations_to_edit_ul");

				for(i=0;i<=list.childElementCount-1;i++){
					list.children[i].addEventListener("click",itemClicked);
				}

				function itemClicked(){
					var locationId = this.getAttribute("myLocationId");
					var ref = firebase.database().ref("locations/" + locationId);
					ref.once('value').then(function(snapshot){
						document.getElementById("verify_edit_location_div").style.display = "block";
						document.getElementById("locations_to_edit_ul").style.display = "none";
						document.getElementById("edit_search_location").value = "";
						document.getElementById("edit_map_location").style.display = "block";
						document.getElementById("update_location_btn").style.display = "block";

						var array = snapshotToArray(snapshot);
						
						var firstName = array[5];
						var lastName = array[6];
						var address = array[0];
						var state = array[10];
						var city = array[1];
						var cong = array[2];
						var lat = array[7];
						var long = array[9];
						mLocationId = array[8];
						mUserId = array[11];
						mSelectedDate = array[3];
						
						document.getElementById("edit_first_name").value = firstName;
						document.getElementById("edit_last_name").value = lastName;
						document.getElementById("edit_address").value = address;
						document.getElementById("edit_city").value = city;
						
						mEditLatnLngFromAddress = {lat: lat, lng: long};

						var edit_map = new google.maps.Map(document.getElementById('edit_map_location'), {
							zoom: 19,
							center: mEditLatnLngFromAddress,
							mapTypeId: 'satellite'
						});
						
						var marker = new google.maps.Marker({
							position: mEditLatnLngFromAddress,
							map: edit_map
						});
						
						markersArray.push(marker);
						setMapOnAll(edit_map);
						
						google.maps.event.addListener(edit_map, "click", function (e) {

							deleteMarkers();

							//lat and lng is available in e object
							var latLng = e.latLng;
							mEditNewLatnLngFromMap = {lat: latLng.lat(), lng: latLng.lng()}

							var marker = new google.maps.Marker({
								position: mEditNewLatnLngFromMap,
								map: edit_map
							});
							
							markersArray.push(marker);
							setMapOnAll(edit_map);

						});
						
					})
				}
		}
		
		function updateLocation(){
			var firstName = document.getElementById("edit_first_name").value;
			var lastName = document.getElementById("edit_last_name").value;
			var address = document.getElementById("edit_address").value;
			var city = document.getElementById("edit_city").value;
			var state = getSelectedText("edit_state_select");
			var cong = getSelectedText("edit_cong_select");
			var congId = mCongregationMap[cong];
			var stateId = mStatesMap[state];
			var lat;
			var lng;
			
			if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
				return;
			}
			
			if(mEditNewLatnLngFromMap.lat == null || mEditNewLatnLngFromMap.lat == null){
				var lat = mEditLatnLngFromAddress.lat;
				var lng = mEditLatnLngFromAddress.lng;
			}else{
				var lat = mEditNewLatnLngFromMap.lat;
				var lng = mEditNewLatnLngFromMap.lng;
			}
			
			var firstAndLastName = firstName + " " + lastName;
			
			var ref = firebase.database().ref("locations/" + mLocationId);
			ref.set({
                latitude: lat,
                longitude: lng,
				firstName: firstName,
				lastName: lastName,
				address: address,
				city: city,
				date: mSelectedDate,
				firstAndLastName: firstAndLastName,
				congregation: congId,
				state: stateId,
                locationId: mLocationId,
				userId: mUserId
            });

			document.getElementById("edit_first_name").value = "";
			document.getElementById("edit_last_name").value = "";
			document.getElementById("edit_address").value = "";
			document.getElementById("edit_city").value = "";
			
			mEditLatnLngFromAddress = {};
			mEditNewLatnLngFromMap = {};
			
			mUserId = null;
			mLocationId = null;
			
			markersArray = [];
			
			mSelectedDate = null;

			document.getElementById("verify_edit_location_div").style.display = "none";
			document.getElementById("edit_map_location").style.display = "none";
			document.getElementById("update_location_btn").style.display = "none";
			setMessage("edit_location_message", "Location updated successfully", 1);
				
			}
		
		function checkIfNameStartsWithString(str, name){
			var strLength = str.length;
			if(strLength <= name.length){
				var nameString = name.substr(0, strLength);	
				if(nameString === str){
					return true;
				}
			}
			return false;
		}
		
		function deleteThisLocation(){
			var ref = database.ref("locations").child(mLocationId);
			ref.remove();
			setMessage("edit_location_message", "Location deleted successfully", 1);
			document.getElementById("verify_edit_location_div").style.display = "none";
			document.getElementById("edit_map_location").style.display = "none";
			document.getElementById("update_location_btn").style.display = "none";
		}
		
		/*
			*****  CHECK FEEDBACK CODE   *****
		*/
		
		function parseDate(date){
		
			var date = parseFloat(date);
			var date = new Date(date);
			
			var year = date.getFullYear();
			var month = date.getMonth() + 1;
			var day = date.getDate();
			
			return month + "/" + day + "/" + year;
		}
		
		function navCheckFeedback(){
			closeNav();
			var unresolvedFeedUl = document.getElementById("unresolved_feedback_ul");
			var resolvedFeedUl = document.getElementById("resolved_feedback_ul");
			document.getElementById("loading_feedback").style.visibility = "hidden";
			document.getElementById("view_feedback").style.visibility = "hidden";
			document.getElementById("check_feedback_div").style.display = "block";
			document.getElementById("edit_location_div").style.display = "none";
			document.getElementById("add_location_div_container").style.display = "none";
			for(var k=0; mLocationFeedbackArray.length > k; k++){
				var itemArray = mLocationFeedbackArray[k];
				var whatsWrong = itemArray.whatsWrong;
				var isResolved = itemArray.isResolved;
				var locationId = itemArray.locationFeedbackKey;
				var date = itemArray.date;
				var notes = itemArray.notes;
				if(isResolved){
					var li = document.createElement("li");
					li.appendChild(document.createTextNode(whatsWrong));
					li.setAttribute("id", "feedback_resolved_li");
					li.setAttribute("locationId", locationId);
					li.setAttribute("date", date);
					li.setAttribute("notes", notes);
					li.setAttribute("whatsWrong", whatsWrong);
					li.setAttribute("isResolved", "1");
					resolvedFeedUl.appendChild(li);
				}else{
					var li = document.createElement("li");
					li.appendChild(document.createTextNode(whatsWrong));
					li.setAttribute("id", "feedback_not_resolved_li");
					li.setAttribute("locationId", locationId);
					li.setAttribute("date", date);
					li.setAttribute("notes", notes);
					li.setAttribute("whatsWrong", whatsWrong);
					li.setAttribute("isResolved", "0");
					unresolvedFeedUl.appendChild(li);	
				}
			}
			
			for(i=0;i<=unresolvedFeedUl.childElementCount-1;i++){
				unresolvedFeedUl.children[i].addEventListener("click",itemClicked);
			}
			
			for(i=0;i<=resolvedFeedUl.childElementCount-1;i++){
				resolvedFeedUl.children[i].addEventListener("click",itemClicked);
			}
			
			function itemClicked(){
				document.getElementById("loading_feedback").style.visibility = "visible";
				document.getElementById("shadow_div").style.visibility = "visible";
				document.getElementById("view_feedback").style.visibility = "visible";
				var locationKey = this.getAttribute("locationId");
				var millis = this.getAttribute("date");
				var date = parseDate(millis);
				var notes = this.getAttribute("notes");
				var whatsWrong = this.getAttribute("whatsWrong");
				var isResolved = this.getAttribute("isResolved");
				
				if(isResolved === "1"){
					document.getElementById("feedback_mark_resolved").style.display = "none";
					document.getElementById("feedback_edit_location").style.display = "none";
				}else{
					document.getElementById("feedback_mark_resolved").style.display = "inline-block";
					document.getElementById("feedback_edit_location").style.display = "inline-block";
				}
				document.getElementById("feedback_whats_wrong").innerHTML = whatsWrong;
				document.getElementById("feedback_notes").innerHTML = notes;
				document.getElementById("feedback_date").innerHTML = date;
				var ref = database.ref('locations').child(locationKey);
				ref.on('value', function(snapshot){
					document.getElementById("loading_feedback").style.visibility = "hidden";
					var array = snapshotToArray(snapshot);
					var address = array[0];
					var city = array[1];
					var stateId = array[10];
					var congId = array[2];
					var name = array[4];
					var state = mStateMapIds[stateId];
					var cong = mCongregationMapIds[congId];
					document.getElementById("first_and_last_name").innerHTML = name;
					document.getElementById("feedback_address").innerHTML = address;
					document.getElementById("feedback_city_and_state").innerHTML = city + ", " + state;
					document.getElementById("feedback_congregation").innerHTML= cong;
				})
			}
			
		}
		
		function feedback_cancel(){
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("view_feedback").style.visibility = "hidden";
			document.getElementById("loading_feedback").style.visibility = "hidden";
		}
		
		function markResolved(){
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("view_feedback").style.visibility = "hidden";
			document.getElementById("loading_feedback").style.visibility = "hidden";
		}
		
		function feedbackEditLocation(){
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("view_feedback").style.visibility = "hidden";
			document.getElementById("loading_feedback").style.visibility = "hidden";
		}
		
	</script>
	
	<script 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA">
	</script>

</body>
</html> 