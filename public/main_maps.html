<!DOCTYPE html>
<html>
<head>
	<title>Mennonite Map</title>
	<link rel="stylesheet" href="main_maps.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="main_maps.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA",
			authDomain: "maps-ca38f.firebaseapp.com",
			databaseURL: "https://maps-ca38f.firebaseio.com",
			projectId: "maps-ca38f",
			storageBucket: "maps-ca38f.appspot.com",
			messagingSenderId: "6568625724"
		};
		firebase.initializeApp(config);
	</script>
</head>
<body>
	<div id="map"></div>
	
	<div id="incorrect_data_div">
		<h3>Select type of problem</h3>
		<select>
			<option value="incorrect_address">Incorrect Location</option>
			<option value="typo">Typo</option>
		</select>
		<h3>Notes</h3>
		<textarea id="incorrect_data_notes"></textarea>
		<input type="button" value="Cancel" class="button" id="incorrect_cancel_btn" onclick="cancelIncorrect()">
		<input type="button" value="Send" class="button" id="incorrect_send_btn" onclick="sendData()">
	</div>
	
	<div id="shadow_div"></div>
	
	<div id="add_location_div">
		<img id="add_location_icon" src="res/add-plus-button.svg">
	</div>
	
	<div id="overlay">
		<div id="menu_and_search_container">
			<div id="menu_container" onclick="showNav()">
				<div class="menu_style"></div>
				<div class="menu_style"></div>
				<div class="menu_style"></div>
			</div>
			<input type="text" placeholder="Search Maps" id="search_input" onkeyup="searchForMatches()">
		</div>
		<center><div class="loader" id="loader_id"></div></center>
		<ul id="names_found_list"></ul>
		<div id="name_details_div">
			<h3 id="name"></h3>
			<h4 id="h_cong" class="name_details"></h4>
			<h4 id="h_address" class="name_details"></h4>
			<h4 id="h_city_and_state" class="name_details"></h4>
			<input class="button" type="button" value="Send feedback on this location" onclick="notifyAsIncorrect()">
		</div>
	</div> 
	
	<div id="side_nav">
		<img src="res/cancel.svg" id="nav_cancel" onclick="closeNav()">
		<ul id="nav_ul">
			<li class="nav_li" onclick="manageSubscription()">Manage Subscription</li>
			<div id="nav_divider_div"></div>
			<li class="nav_li" onclick="buyBeer()">Buy the dev a beer</li>
			<div id="nav_divider_div"></div>
			<li class="nav_li" onclick="sendFeedback()">Send Feedback</li>
			<div id="nav_divider_div"></div>
			<li class="nav_li" onclick="signOut()">Sign Out</li>
		</ul>
	</div>

	<script>

		var mMap;
		
		document.getElementById("name_details_div").style.visibility = "hidden";
		document.getElementById("loader_id").style.display = "none"; 
		document.getElementById("incorrect_data_div").style.visibility = "hidden";
		document.getElementById("shadow_div").style.visibility = "hidden";
		document.getElementById("side_nav").style.visibility = "hidden";

	document.getElementById("add_location_div").addEventListener('click', addLocation);
		function initMap() {

			navigator.geolocation.getCurrentPosition(function(location){
				var whereToCenter = {lat: location.coords.latitude, lng: location.coords.longitude};
				mMap = new google.maps.Map(document.getElementById('map'), {
					zoom: 7,
					center: whereToCenter,
					mapTypeControlOptions: {
						position: google.maps.ControlPosition.LEFT_BOTTOM,
						fullscreenControl: false,
					}
				});

				mMap.setOptions({streetViewControl: false, zoomControl: false, fullscreenControl: false});

				var locations = []

				var databaseRef = firebase.database().ref('locations');
				databaseRef.on('value', function(snapshot){
					var array = snapshotToArray(snapshot);
					for(var i=0; i<array.length; i++){
						itemArray = array[i];

						var name = itemArray.firstAndLastName;
						var lat = itemArray.latitude;
						var long = itemArray.longitude;
						var id = itemArray.locationId;

						var newArray = new Array(name, lat, long, id);
						locations.push(newArray);
					}


					for (var i = 0; i < locations.length; i++) {
						var location = locations[i];

						var marker = new google.maps.Marker({
							position: {lat: parseFloat(location[1]), lng: parseFloat(location[2])},
							map: mMap,
							title: location[0],
							locationId: location[3]
						});

						marker.addListener('click', function(){
							document.getElementById("names_found_list").innerHTML = "";
							document.getElementById("name_details_div").style.visibility = "visible";
							var id = this.get("locationId");
							var databaseRef = firebase.database().ref("locations/" + id);
							databaseRef.once('value').then(function(snapshot){
								var array = snapshot.val();
								var firstName = array.firstName;
								var lastName = array.lastName;
								var address = array.address;
								var city = array.city;
								var state = array.state;
								var cong = array.congregation;
								var lat = array.latitude;
								var long = array.longitude;
								document.getElementById("name").innerHTML = firstName + " " + lastName;
								document.getElementById("h_address").innerHTML = address;
								document.getElementById("h_cong").innerHTML = cong;
								document.getElementById("h_city_and_state").innerHTML = city + ", " + state;
								var whereToZoom = {lat: lat, lng: long};
								smoothZoom(mMap, 16, mMap.getZoom());
								mMap.panTo(whereToZoom);
							})
						})
					}
				});
			})
		}  

		function notifyAsIncorrect(){
			document.getElementById("incorrect_data_div").style.visibility = 'visible';
			document.getElementById("shadow_div").style.visibility = 'visible';
		}

		function cancelIncorrect(){
			document.getElementById("incorrect_data_div").style.visibility = 'hidden';
			document.getElementById("shadow_div").style.visibility = 'hidden';
		}

		function sendData(){

		}

		function addLocation(){
			location.href = "add_location.html";
		}
		
		function buyBeer(){
			alert("Buy Beer");
		}
		
		function sendFeedback(){
			alert("Send Feedback");
		}
		
		function signOut(){
			firebase.auth().signOut().then(function() {
				console.log('Signed Out');
			}, function(error) {
				console.error('Sign Out Error', error);
			});
		}
		
		function manageSubscription(){
			alert("Manage Subscription");
		}
		
		function showNav(){
			document.getElementById("shadow_div").style.visibility = "visible";
			document.getElementById("side_nav").style.visibility = "visible";
		}
		
		function closeNav(){
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("side_nav").style.visibility = "hidden";
		}

		function searchForMatches(){
			document.getElementById("names_found_list").innerHTML = "";
			var equalTo = capitalizeFirstLetter(document.getElementById("search_input").value);
			if(equalTo.length == 0){
				var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				if(screenWidth < 615){
					var container = document.getElementById('overlay');
					container.style.height = (container.offsetHeight + -150) + "px";
				}
				return;
			}
			setOverlayDivHeight(150);
			document.getElementById("name_details_div").style.visibility = "hidden";
			document.getElementById("loader_id").style.display = "block";
			var ref = firebase.database().ref("locations").orderByChild('firstName').startAt(equalTo).limitToLast(3);
			ref.once('value').then(function(snapshot){
				var array = snapshotToArray(snapshot);
				for(var j=0; array.length > j; j++){
					var itemArray = array[j];
					var firstName = itemArray.firstName;
					var lastName = itemArray.lastName;
					var locationId = itemArray.locationId;
					var name = firstName + " " + lastName;

					var ul = document.getElementById('names_found_list');
					var li = document.createElement("li");
					li.appendChild(document.createTextNode(name));
					li.setAttribute("id", "li_items");
					li.setAttribute("myLocationId", locationId);
					ul.appendChild(li);
				}

				var list = document.getElementById("names_found_list");

				for(i=0;i<=list.childElementCount-1;i++){
					list.children[i].addEventListener("click",itemClicked);
				}

				document.getElementById("loader_id").style.display = "none"; 

				function itemClicked(){
					document.getElementById("search_input").value= "";
					document.getElementById("names_found_list").innerHTML = "";
					document.getElementById("name_details_div").style.visibility = "visible";
					var locationId = this.getAttribute("myLocationId");
					var ref = firebase.database().ref("locations/" + locationId);
					ref.once('value').then(function(snapshot){
						var array = snapshot.val();
						var firstName = array.firstName;
						var lastName = array.lastName;
						var address = array.address;
						var city = array.city;
						var state = array.state;
						var cong = array.congregation;
						var lat = array.latitude;
						var long = array.longitude;
						document.getElementById("name").innerHTML = firstName + " " + lastName;
						document.getElementById("h_address").innerHTML = address;
						document.getElementById("h_cong").innerHTML = cong;
						document.getElementById("h_city_and_state").innerHTML = city + ", " + state;
						var whereToZoom = {lat: lat, lng: long};
						smoothZoom(mMap, 16, mMap.getZoom());
						mMap.panTo(whereToZoom);
					})
				}
			})
		}

		function listItemClicked(){
			console.log("Clicked");
		}

		function snapshotToArray(snapshot) {
			var returnArr = [];

			snapshot.forEach(function(childSnapshot) {
				var item = childSnapshot.val();
				item.key = childSnapshot.key;

				returnArr.push(item);
			});

			return returnArr;
		};

		function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}

		function smoothZoom (map, max, cnt) {
			if (cnt >= max) {
				return;
			}
			else {
				z = google.maps.event.addListener(map, 'zoom_changed', function(event){
					google.maps.event.removeListener(z);
					smoothZoom(map, max, cnt + 1);
				});
				setTimeout(function(){map.setZoom(cnt)}, 80); 
			}
		}  

		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				
			} else {
				location.href = "index.html";
			}
		});

		function setOverlayDivHeight(height){
			var container = document.getElementById('overlay');
			var currentHeight = container.style.height;
			var currentHeightInt;
			if(currentHeight.length == 5){
				currentHeightInt = parseInt(currentHeight.substring(0, 3));
			}else if(currentHeight.length == 4){
				currentHeightInt = parseInt(currentHeight.substring(0, 2));
			}else{
				currentHeightInt = 0;
			}
			var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
			if(screenWidth < 615){
				if(currentHeightInt < 205){
					container.style.height = (container.offsetHeight + height) + "px";
				}
			}
		}

	</script>

	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA&callback=initMap">
	</script>
</body>
</html>