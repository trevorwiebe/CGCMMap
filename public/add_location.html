 <!DOCTYPE html>
<html>
<head>
    <title>Add Location</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="index.css">
    <link rel="stylesheet" href="add_location.css">
      <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
      <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCF9ON6rwVZVm-QDQ-ngUi5vc8-NPLnP0M",
            authDomain: "maps-ca38f.firebaseapp.com",
            databaseURL: "https://maps-ca38f.firebaseio.com",
            projectId: "maps-ca38f",
            storageBucket: "",
            messagingSenderId: "6568625724"
        };
          
        firebase.initializeApp(config);
          
      </script>
    
</head>
<body>
    
	<div id="container">
		<div id="add_location">
			<center><h2 class="tags">Add new Location</h2></center>
			<input type="text" id="first_name" class="input" placeholder="First Name"><br>
			<input type="text" id="last_name" class="input" placeholder="Last Name"><br>
			<input type="text" id="address" class="input" placeholder="Address"><br>
			<input type="text" id="city" class="input" placeholder="City"><br>
			
			<center><h4 id="h_state_congregation_selected" class="tags">State or Province Selected:</h4></center>
			<center><h3 id="h_state" class="tags"></h3></center>
			
			<div class="dropdown">
			  <button onclick="stateDropDownFunction()" class="dropbtn" id="state_drop_down_btn">Select State or Province</button>
			  <div id="stateDropDown" class="dropdown-content">
				  <ul id="state_ul">
				  </ul>
			  </div>
			</div>
		
			<center><h4 id="h_congregation_selected" class="tags">Congregation Selected:</h4></center>
			<center><h3 id="h_congregation" class="tags"></h3></center>
			
			<div class="dropdown">
			  <button onclick="congDropDownFunction()" class="dropbtn" id="cong_drop_down_btn">Select Congregation</button>
			  <div id="congDropDown" class="dropdown-content">
				<ul id="cong_ul">
				</ul>
			  </div>
			</div>
	
		
			<center><input type="button" id="save_location" class="save_button" value="Save Location"></center>
		</div>
		<div id="add_state_and_congregation">
			<center><h2 class="tags">Add new State or Province</h2></center>
			<input type="text" id="state" class="input" placeholder="State or Province"><br>
			<center><input type="button" id="save_state" class="save_button" value="Save State or Province" onclick="saveState()"></center>
			<center><h2 class="tags">Add new Congregation</h2></center>
			<input type="text" id="congregation" class="input" placeholder="Congregation"><br>
			<center><input type="button" id="save_congregation" class="save_button" value="Save Congregation" onclick="saveCongregation()"></center>
		</div>
	</div>
       
    <script>
    
		var mCongregationMap = {};
		var mCongregationArray = [];
		
		var mStatesMaps = {};
		var mStatesArray = [];
		
		var database = firebase.database();
		
		database.ref('congregations').on('value', function(snapshot){
			document.getElementById("cong_ul").innerHTML = "";
			parseCongSnapshot(snapshot);
		});
		
		database.ref('stateOrProvidence').on('value', function(snapshot){
			document.getElementById("state_ul").innerHTML = "";
			parseStateSnapshot(snapshot);
		});
		
		var congregation_ul = document.getElementById("cong_ul");
		congregation_ul.onclick = function(event){
			var name = event.target.innerHTML;
			document.getElementById("h_congregation").innerHTML = name;
		}
		
		var state_ul = document.getElementById("state_ul");
		state_ul.onclick = function(event){
			var name = event.target.innerHTML;
			document.getElementById("h_state").innerHTML = name;
		}
		
        document.getElementById("save_location").addEventListener("click", function(){
            
            var firstName = document.getElementById('first_name').value;
			var lastName = document.getElementById('last_name').value;
			var address = document.getElementById('address').value;
			var city = document.getElementById('city').value;
			var state = document.getElementById('h_state').innerHTML;
			var cong = document.getElementById('h_congregation').innerHTML;
            
//            if(firstName.length == 0 || lastName.length == 0 || address.length == 0 || city.length == 0 || state.length == 0 || cong.length == 0){
//                return;
//            }
            
			var addressString = address.split(" ");
			var finishedAddresString = "";
			for(var i=0; addressString.length > i; i++){
				var item = addressString[i];
				finishedAddresString = finishedAddresString + item + "+";	
			}

			finishedAddresString = finishedAddresString.slice(0, -1);
			
			var apiKey = "&key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA";
			var baseUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=";
			var url = baseUrl + finishedAddresString + apiKey;
			var request = new XMLHttpRequest();
			request.onreadystatechange = function(){
				if(this.readyState == 4 && this.status == 200){
					var json = JSON.parse(this.responseText);
					var lat_n_long = json.results[0].geometry.location;
					
					var lat = lat_n_long.lat;
					var long = lat_n_long.lng;
					
					saveLocation(lat, long, firstName, lastName, city, state, address, cong);

				}
			}
			request.open('GET', url);
			request.send();
         
            document.getElementById('first_name').value = "";
			document.getElementById('last_name').value = "";
			document.getElementById('address').value = "";
			document.getElementById('city').value = ""

            
        });
		
	    function saveLocation(varLatitude, varLongitude, varFirstName, varLastName, varCity, varState, varAddress, varCong){
            var ref = firebase.database().ref('locations').push();
            var key = ref.getKey();
            ref.set({
                latitude: varLatitude,
                longitude: varLongitude,
				firstName: varFirstName,
				lastName: varLastName,
				address: varAddress,
				city: varCity,
				congregation: varCong,
				state: varState,
                locationId: key
            });
        }
        
		function saveState(){
			var state = document.getElementById("state").value;
			if(state.length == 0){
				return;
			}
			var ref = firebase.database().ref('stateOrProvidence').push();
			var key = ref.getKey();
			ref.set({
				stateId: key,
				state: state
			});
			document.getElementById("state").value = "";
		}
		
		function saveCongregation(){
			var cong = document.getElementById("congregation").value;
			if(cong.length == 0){
				return;
			}
			var ref = firebase.database().ref('congregations').push();
			var key = ref.getKey();
			ref.set({
				congregationId: key,
				congregation: cong
			});
			document.getElementById("congregation").value = "";
		}
		
		function parseCongSnapshot(snapshot) {
			var congUl = document.getElementById("cong_ul");
    	   snapshot.forEach(function(childSnapshot) {
			   var name = childSnapshot.val().congregation;
			   var nameId = childSnapshot.val().congregationId;
			   	
			   var node = document.createElement("LI");
			   node.setAttribute("id", "cong_li");
			   var textNode = document.createTextNode(name);
			   node.appendChild(textNode);
			   congUl.appendChild(node)
			   
			   mCongregationArray.push(name);
			   mCongregationMap[nameId] = name;
    	   });

	     };
		
		function parseStateSnapshot(snapshot){
			var stateUl = document.getElementById("state_ul");
			snapshot.forEach(function(childSnapshot){
				var name = childSnapshot.val().state;
				var nameId = childSnapshot.val().stateId;
				
				var node = document.createElement("LI");
				node.setAttribute("id", "state_li");
				var textNode = document.createTextNode(name);
				node.appendChild(textNode);
				stateUl.appendChild(node);
				
				mStatesArray.push(name);
				mStatesArray[nameId] = name;
			})
		};
		
		/* When the user clicks on the button, 
		toggle between hiding and showing the dropdown content */
		function stateDropDownFunction() {
			document.getElementById("stateDropDown").classList.toggle("show");
		}
		
		function congDropDownFunction() {
			document.getElementById("congDropDown").classList.toggle("show");
		}

		// Close the dropdown menu if the user clicks outside of it
		window.onclick = function(event) {
		  if (!event.target.matches('.dropbtn')) {

			var dropdowns = document.getElementsByClassName("dropdown-content");
			var i;
			for (i = 0; i < dropdowns.length; i++) {
			  var openDropdown = dropdowns[i];
			  if (openDropdown.classList.contains('show')) {
				openDropdown.classList.remove('show');
			  }
			}
		  }
		}
        
    </script>
</body>
</html> 