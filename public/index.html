<!DOCTYPE html>
<html>
<head>
	<title>Mennonite Map</title>
	<link rel="stylesheet" href="index.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="index.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA",
			authDomain: "maps-ca38f.firebaseapp.com",
			databaseURL: "https://maps-ca38f.firebaseio.com",
			projectId: "maps-ca38f",
			storageBucket: "maps-ca38f.appspot.com",
			messagingSenderId: "6568625724"
		};
		firebase.initializeApp(config);
	</script>
</head>
<body>
	
	<div id="map"></div>
	
	<div id="sign_in">
		<h1>Mennonite Maps</h1>
		<h3>Please sign in to continue.</h3>
		<p id="fill_in_email_address"></p>
		<input type="text" class="credentials" id="email_address" placeholder="Email"><br>
		<p id="fill_in_password">Please fill in password.</p>
		<input type="password" class="credentials" id="password" placeholder="Password"><br>
		<div id="loader"></div>
		<input type="button" class="log_in_button" onclick="logIn();" value="LOG IN">
		<p id="error">There was an error signing in.</p>
		<input type="button" class="register_button" onclick="register();" value="REGISTER">
	</div>
	
	<div id="total_feedback">
		<h2>Feedback:</h2>
		<textarea id="total_feedback_text_area"></textarea>
		<center><h4 id="feedback_error">Please type some feedback before sending.</h4></center>
		<input type="button" class="button" id="total_feedback_cancel" onclick="cancelSendWholeFeedback()" value="Cancel">
		<input type="button"  class="button" value="Send" onclick="sendFeedbackOnWholeSite()">
	</div>
	
	<div id="incorrect_data_div">
		<h3>Select type of problem</h3>
		<select id="whats_wrong">
			<option value="incorrect_address">Location is incorrect</option>
			<option value="incorrect_address">Address is incorrect</option>
			<option value="typo">Name Typo</option>
			<option value="other">Other</option>
		</select>
		<h3>What should it be?</h3>
		<textarea id="incorrect_data_notes"></textarea>
		<input type="button" value="Cancel" class="button" id="incorrect_cancel_btn" onclick="cancelIncorrect()">
		<input type="button" value="Send" class="button" id="incorrect_send_btn" onclick="sendFeedbackOnLocation()">
	</div>
	
	<div id="shadow_div"></div>
	
	<div id="loading_div">
		<div class="loader" id="loader_id"></div>
		<center><h2 class="name_details" id="loading_maps_text">Loading Address Book...</h2></center>
	</div>
	
	<div id="overlay">
		<div id="menu_and_search_container">
			<div id="menu_container" onclick="openNav()">
				<div class="menu_style"></div>
				<div class="menu_style"></div>
				<div class="menu_style"></div>
			</div>
			<input type="text" placeholder="Search Maps" id="search_input" onkeyup="searchForMatches()">
		</div>
		<ul id="names_found_list"></ul>
		<div id="name_details_div">
			<h3 id="name"></h3>
			<h4 id="h_cong" class="name_details"></h4>
			<h4 id="h_address" class="name_details"></h4>
			<h4 id="h_city_and_state" class="name_details"></h4>
			<h4></h4>
			<a href="#" onclick="notifyAsIncorrect()" class="send_feed_back_link">Send feedback on this location</a>
		</div>
	</div> 
	
	<div id="side_nav" class="sidenav">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
		<a href="#" onclick="information()">Stats</a>
		<div class="nav_divider_div"></div>
		<a href="#" onclick="showSendFeedbackOnWholeSite()">Send Feedback</a>
		<div class="nav_divider_div"></div>
		<a href="#" onclick="admin()" id="registered_user_href">Registered User</a>
		<div class="nav_divider_div" id="registered_user_div"></div>
		<a href="#" onclick="buyBeer()">Donate</a>
		<div class="nav_divider_div"></div>
		<a href="#" onclick="signInAndOut()" id="sign_in_out_href"></a>
	</div>

	<script>

		var mMap;
		var mUser;
		var mWhoAddedIt;
		
		document.getElementById("feedback_error").style.visibility = "hidden";
		document.getElementById("total_feedback").style.visibility = "hidden";
		document.getElementById("name_details_div").style.visibility = "hidden";
		document.getElementById("incorrect_data_div").style.visibility = "hidden";
		document.getElementById("shadow_div").style.visibility = "hidden";
		document.getElementById("side_nav").style.visibility = "hidden";
		document.getElementById("sign_in").style.visibility = "hidden";
		document.getElementById("loader").style.visibility = "hidden";
		document.getElementById("fill_in_email_address").style.visibility = "hidden";
		document.getElementById("fill_in_password").style.visibility = "hidden";
		document.getElementById("error").style.visibility = "hidden";
		
		document.onclick = close_menus;

		function initMap() {

			navigator.geolocation.getCurrentPosition(function(location){
				var whereToCenter = {lat: location.coords.latitude, lng: location.coords.longitude};
				mMap = new google.maps.Map(document.getElementById('map'), {
					zoom: 10,
					center: whereToCenter,
					mapTypeControlOptions: {
						position: google.maps.ControlPosition.LEFT_BOTTOM,
						fullscreenControl: false,
					}
				});

				mMap.setOptions({streetViewControl: false, zoomControl: false, fullscreenControl: false});

				var locations = []

				var databaseRef = firebase.database().ref('locations');
				databaseRef.on('value', function(snapshot){
					var array = snapshotToArray(snapshot);
					for(var i=0; i<array.length; i++){
						itemArray = array[i];

						var name = itemArray.firstAndLastName;
						var lat = itemArray.latitude;
						var long = itemArray.longitude;
						var id = itemArray.locationId;

						var newArray = new Array(name, lat, long, id);
						locations.push(newArray);
					}


					for (var i = 0; i < locations.length; i++) {
						var location = locations[i];

						var marker = new google.maps.Marker({
							position: {lat: parseFloat(location[1]), lng: parseFloat(location[2])},
							map: mMap,
							title: location[0],
							locationId: location[3]
						});

						marker.addListener('click', function(){
							document.getElementById("names_found_list").innerHTML = "";
							document.getElementById("name_details_div").style.visibility = "visible";
							var locationId = this.get("locationId");
							mWhoAddedIt = this.get("userId");
							var databaseRef = firebase.database().ref("locations/" + locationId);
							databaseRef.once('value').then(function(snapshot){
								parseAndRenderSnapshot(snapshot);
							})
						})
					}
					
					// Fade out loading div
					var loading_div = document.getElementById("loading_div");
					fade(loading_div);
				});
			})
		}  

		function notifyAsIncorrect(){
			document.getElementById("incorrect_data_div").style.visibility = 'visible';
			document.getElementById("shadow_div").style.visibility = 'visible';
		}

		function cancelIncorrect(){
			document.getElementById("incorrect_data_div").style.visibility = 'hidden';
			document.getElementById("shadow_div").style.visibility = 'hidden';
		}

		function sendFeedbackOnLocation(){
			var notes = document.getElementById("incorrect_data_notes").value;
			var whatsWrong = getSelectedText("whats_wrong");
			var ref = firebase.database().ref("locationFeedback/" + mWhoAddedIt).push();
			var key = ref.getKey();
			ref.set({
				locationFeebackKey: key,
				whatsWrong: whatsWrong,
				notes: notes
			})
			document.getElementById("incorrect_data_div").style.visibility = 'hidden';
			document.getElementById("shadow_div").style.visibility = 'hidden';
		}

		function admin(){
			location.href = "admin_check_feedback.html";
		}
		
		function buyBeer(){
			closeNav();
			var windowObjectReference;
			windowObjectReference = window.open("https://www.paypal.me/trevwiebe", "PayPal");
		}
		
		function sendFeedbackOnWholeSite(){
			var ref = firebase.database().ref("totalFeedback").push();
			var key = ref.getKey();
			var feedback = document.getElementById("total_feedback_text_area").value;
			if(feedback.length == 0){
				document.getElementById("feedback_error").style.visibility = "visible";
				return;
			}
			ref.set({
				feedbackId: key,
				feedback: feedback
			})
			document.getElementById("feedback_error").style.visibility = "hidden";
			document.getElementById("total_feedback").style.visibility = "hidden";
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("total_feedback_text_area").value = "";
		}
		
		function cancelSendWholeFeedback(){
			document.getElementById("feedback_error").style.visibility = "hidden";
			document.getElementById("total_feedback").style.visibility = "hidden";
			document.getElementById("shadow_div").style.visibility = "hidden";
		}
		
		function information(){
			closeNav();	
		}
		
		function showSendFeedbackOnWholeSite(){
			closeNav();
			document.getElementById("total_feedback").style.visibility = "visible";
			document.getElementById("shadow_div").style.visibility = "visible";
		}
		
		function signInAndOut(){
			if(mUser){
				firebase.auth().signOut().then(function() {
					console.log('Signed Out');
				}, function(error) {
					console.error('Sign Out Error', error);
				});	
				closeNav();
			}else{
				closeNav();
				document.getElementById("sign_in").style.visibility = "visible";
				document.getElementById("shadow_div").style.visibility = "visible";
				mJustClickedSignIn = true;
			}
		}	

		function searchForMatches(){
			document.getElementById("names_found_list").innerHTML = "";
			var equalTo = capitalizeFirstLetter(document.getElementById("search_input").value);
			if(equalTo.length == 0){
				document.getElementById("name_details_div").style.visibility = "hidden";
				var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				if(screenWidth < 615){
					var container = document.getElementById('overlay');
					container.style.height = (container.offsetHeight + -150) + "px";
				}
				return;
			}
			setOverlayDivHeight(150);
			document.getElementById("name_details_div").style.visibility = "hidden";
			var ref = firebase.database().ref("locations").orderByChild('firstName').startAt(equalTo).limitToFirst(3);
			ref.once('value').then(function(snapshot){
				var array = snapshotToArray(snapshot);
				for(var j=0; array.length > j; j++){
					var itemArray = array[j];
					var firstName = itemArray.firstName;
					var lastName = itemArray.lastName;
					var locationId = itemArray.locationId;
					var userId = itemArray.userId;
					var name = firstName + " " + lastName;

					var ul = document.getElementById('names_found_list');
					var li = document.createElement("li");
					li.appendChild(document.createTextNode(name));
					li.setAttribute("id", "li_items");
					li.setAttribute("myLocationId", locationId);
					li.setAttribute("myWhoAddedItId", userId);
					ul.appendChild(li);
				}

				var list = document.getElementById("names_found_list");

				for(i=0;i<=list.childElementCount-1;i++){
					list.children[i].addEventListener("click",itemClicked);
				}


				function itemClicked(){
					document.getElementById("search_input").value= "";
					document.getElementById("names_found_list").innerHTML = "";
					document.getElementById("name_details_div").style.visibility = "visible";
					var locationId = this.getAttribute("myLocationId");
					mWhoAddedIt = this.getAttribute("myWhoAddedItId");
					var ref = firebase.database().ref("locations/" + locationId);
					ref.once('value').then(function(snapshot){
						parseAndRenderSnapshot(snapshot);
					})
				}
			})
		}

		function snapshotToArray(snapshot) {
			var returnArr = [];

			snapshot.forEach(function(childSnapshot) {
				var item = childSnapshot.val();
				item.key = childSnapshot.key;

				returnArr.push(item);
			});

			return returnArr;
		};

		function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}

		function smoothZoom (map, max, cnt) {
			if (cnt >= max) {
				return;
			}
			else {
				z = google.maps.event.addListener(map, 'zoom_changed', function(event){
					google.maps.event.removeListener(z);
					smoothZoom(map, max, cnt + 1);
				});
				setTimeout(function(){map.setZoom(cnt)}, 80); 
			}
		}  

		function parseAndRenderSnapshot(snapshot){
			var array = snapshot.val();
			var firstName = array.firstName;
			var lastName = array.lastName;
			var address = array.address;
			var city = array.city;
			var stateId = array.state;
			var congId = array.congregation;
			var lat = array.latitude;
			var long = array.longitude;
			var locationId = array.locationId;
			
			var ref = firebase.database().ref("congregations/" + congId + "/congregation");
			ref.once('value').then(function(snapshot){
				
				var cong = snapshot.val();
				
				var stateRef = firebase.database().ref("stateOrProvince/" + stateId + "/state");
				stateRef.once('value').then(function(snapshot){
					var state = snapshot.val();
					document.getElementById("name").innerHTML = firstName + " " + lastName;
					document.getElementById("h_address").innerHTML = address;
					document.getElementById("h_cong").innerHTML = cong;
					document.getElementById("h_city_and_state").innerHTML = city + ", " + state;
					var whereToZoom = {lat: lat, lng: long};
					smoothZoom(mMap, 20, mMap.getZoom());
					mMap.panTo(whereToZoom);
					setOverlayDivHeight(150);
				})

			})
			
		}

		function setOverlayDivHeight(height){
			var container = document.getElementById('overlay');
			var currentHeight = container.style.height;
			var currentHeightInt;
			if(currentHeight.length == 5){
				currentHeightInt = parseInt(currentHeight.substring(0, 3));
			}else if(currentHeight.length == 4){
				currentHeightInt = parseInt(currentHeight.substring(0, 2));
			}else{
				currentHeightInt = 0;
			}
			var screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
			if(screenWidth < 615){
				if(currentHeightInt < 205){
					container.style.height = (container.offsetHeight + height) + "px";
				}
			}
		}
		
		function fade(element) {
			var op = 1;  // initial opacity
			var timer = setInterval(function () {
				if (op <= 0.1){
					clearInterval(timer);
					element.style.display = 'none';
				}
				element.style.opacity = op;
				element.style.filter = 'alpha(opacity=' + op * 100 + ")";
				op -= op * 0.1;
			}, 30);
		}
		
		function openNav() {
			document.getElementById("shadow_div").style.visibility = "visible";
			document.getElementById("side_nav").style.visibility = "visible";
			document.getElementById("side_nav").style.width = "350px";
		}

		function closeNav() {
			document.getElementById("shadow_div").style.visibility = "hidden";
			document.getElementById("side_nav").style.width = "0";
		}
		
		function getSelectedText(elementId) {
			var elt = document.getElementById(elementId);

			if (elt.selectedIndex == -1)
				return null;

			return elt.options[elt.selectedIndex].text;
		}
		
		function logIn() {
			document.getElementById("error").style.visibility = "hidden";
			var email_address = document.getElementById("email_address").value;
			var input_password = document.getElementById("password").value;
			if(email_address.length == 0 && input_password.length == 0){
				document.getElementById("fill_in_password").style.visibility = "visible";
				document.getElementById("fill_in_email_address").style.visibility = "visible";
				setErrorEmailErrorText("Please fill in email address.")
			}else if(input_password.length == 0){
				document.getElementById("fill_in_password").style.visibility = "visible";
				document.getElementById("fill_in_email_address").style.visibility = "hidden";
			}else if(email_address.length == 0){
				document.getElementById("fill_in_email_address").style.visibility = "visible";
				setErrorEmailErrorText("Please fill in email address.")
				document.getElementById("fill_in_password").style.visibility = "hidden";
			}else{
				document.getElementById("fill_in_email_address").style.visibility = "hidden";
				document.getElementById("fill_in_password").style.visibility = "hidden";
				if(validateEmail(email_address)){
					document.getElementById("loader").style.visibility = "visible";
					firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(function(){
						firebase.auth().signInWithEmailAndPassword(email_address, input_password).catch(function(error){
							var errorCode = error.code;
							var errorMessage = error.message;
							document.getElementById("loader").style.visibility = "hidden";
							document.getElementById("fill_in_email_address").style.visibility = "hidden";
							document.getElementById("fill_in_password").style.visibility = "hidden";
							document.getElementById("error").style.visibility = "visible";	
						})
					}).catch(function(error){
						document.getElementById("loader").style.visibility = "hidden";
						document.getElementById("fill_in_email_address").style.visibility = "hidden";
						document.getElementById("fill_in_password").style.visibility = "hidden";
						document.getElementById("error").style.visibility = "visible";
					});
				}else{
					document.getElementById("fill_in_email_address").style.visibility = "visible";
					setErrorEmailErrorText( email_address + " is not a valid email address.");
				}
			}
		}

		function register(){
			location.href = "register.html";
		}
		
		function validateEmail(mail){  
			if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)){  
				return (true)  
			}   
			return (false)  
		}  

		function setErrorEmailErrorText(error_text) {
			document.getElementById("fill_in_email_address").innerHTML = error_text;
		}
		
		function close_menus(e){
			if(e.target.id === "shadow_div"){
				
				// close sign in dialog
				var sign_in = document.getElementById("sign_in");
				var style = window.getComputedStyle(sign_in);
				if(style.visibility === 'visible'){
					document.getElementById("shadow_div").style.visibility = "hidden";
					document.getElementById("sign_in").style.visibility = "hidden";	
				}
				
				// close nav drawer
				var nav_drawer = document.getElementById("side_nav");
				var nav_style = window.getComputedStyle(nav_drawer);
				if(nav_style.width !== '0px'){
					closeNav();
				}
				
				// close main feedback
				var main_feed_back_div = document.getElementById("total_feedback");
				var main_feed_back_style = window.getComputedStyle(main_feed_back_div);
				if(main_feed_back_style.visibility === 'visible'){
					main_feed_back_div.style.visibility = "hidden";
					document.getElementById("shadow_div").style.visibility = "hidden";
				}
				
				// close feedback on location
				var location_feed_back_div = document.getElementById("incorrect_data_div");
				var location_feed_back_style = window.getComputedStyle(location_feed_back_div);
				if(location_feed_back_style.visibility === 'visible'){
					location_feed_back_div.style.visibility = "hidden";
					document.getElementById("shadow_div").style.visibility = "hidden";
				}
			}	
		}
	
		firebase.auth().onAuthStateChanged(function(user) {
			mUser = user;
			if (user) {
				document.getElementById("registered_user_href").style.display = "block";
				document.getElementById("registered_user_div").style.display = "block";
				document.getElementById("sign_in_out_href").innerHTML = "Sign Out";
				document.getElementById("shadow_div").style.visibility = "hidden";
				document.getElementById("sign_in").style.visibility = "hidden";
				document.getElementById("loader").style.visibility = "hidden";
			} else {
				document.getElementById("registered_user_div").style.display = "none";
				document.getElementById("registered_user_href").style.display = "none";
				document.getElementById("sign_in_out_href").innerHTML = "Sign In";
			}
		});
		
	</script>

	<script 
		async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9GSNr_y7G9nRoTXnJ7wNY9N7ACt9u8SA&callback=initMap">
	</script>
</body>
</html>